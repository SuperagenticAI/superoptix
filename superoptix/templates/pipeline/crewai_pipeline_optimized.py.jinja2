"""
{{ agent_name | to_pascal_case }} Agent - CrewAI Optimized Pipeline

Auto-generated from SuperSpec playbook using SuperOptiX compiler.
Framework: CrewAI
Generated: {{ timestamp }}
"""

from __future__ import annotations

import json
import time
from pathlib import Path
from typing import Any, Dict, Optional

from crewai import Agent, Crew, Process, Task

from superoptix.core.base_component import BaseComponent
from superoptix.runners.crewai_runtime_helpers import (
    build_instructions as superoptix_build_instructions,
    build_task_description as superoptix_build_task_description,
    create_crewai_llm as superoptix_create_crewai_llm,
    extract_crewai_output as superoptix_extract_crewai_output,
    resolve_model as superoptix_resolve_model,
{% set tools_cfg = (spec.get("tools", {}) or {}) %}
{% set dspy_tools_cfg = ((spec.get("dspy", {}) or {}).get("tools", {}) or {}) %}
{% set stackone_cfg = spec.get("stackone") or tools_cfg.get("stackone") or dspy_tools_cfg.get("stackone") %}
{% set stackone_mode = (spec.get("stackone_mode") or tools_cfg.get("mode") or dspy_tools_cfg.get("mode") or "") | string | lower %}
{% set include_stackone_code = (stackone_mode in ["stackone", "stackone_discovery"]) or (stackone_cfg is mapping and (stackone_cfg | length > 0)) %}
{% set crewai_rlm_cfg = ((spec.get("crewai", {}) or {}).get("rlm")) %}
{% set include_rlm_code = (crewai_rlm_cfg is mapping and (crewai_rlm_cfg | length > 0)) or (spec.get("rlm") is mapping and (spec.get("rlm") | length > 0)) %}
{% if include_stackone_code %}
    build_stackone_tools as superoptix_build_stackone_tools,
{% endif %}
{% if include_rlm_code %}
    run_with_optional_rlm as superoptix_run_with_optional_rlm,
{% endif %}
)

COMPILED_SPEC_PATH = Path(__file__).resolve().parent / "{{ compiled_spec_filename }}"
def _load_compiled_spec(path: Path) -> Dict[str, Any]:
    try:
        with path.open("r", encoding="utf-8") as _spec_file:
            return json.load(_spec_file)
    except FileNotFoundError as exc:
        raise FileNotFoundError(
            f"Compiled spec file not found at {path}. Recompile this agent to regenerate pipeline artifacts."
        ) from exc
    except json.JSONDecodeError as exc:
        raise ValueError(
            f"Compiled spec file is invalid JSON at {path}. Recompile this agent to regenerate pipeline artifacts."
        ) from exc


FULL_SPEC = _load_compiled_spec(COMPILED_SPEC_PATH)

LANGUAGE_MODEL = dict(FULL_SPEC.get("language_model", {}) or {})
INSTRUCTION_SPEC = {
    "persona": dict(FULL_SPEC.get("persona", {}) or {}),
    "tasks": list(FULL_SPEC.get("tasks", []) or []),
}
OPTIMIZATION_CONFIG = dict(FULL_SPEC.get("optimization", {}) or {})


class {{ agent_name | to_pascal_case }}Component(BaseComponent):
    """BaseComponent wrapper for CrewAI."""

    def __init__(
        self,
        instructions: Optional[str] = None,
        model_config: Optional[Dict[str, Any]] = None,
    ):
        resolved_instructions = instructions or superoptix_build_instructions(
            INSTRUCTION_SPEC
        )
        resolved_model = superoptix_resolve_model(
            LANGUAGE_MODEL, model_config=model_config
        )
        task_description = superoptix_build_task_description(INSTRUCTION_SPEC)
{% if include_stackone_code %}
        tools = superoptix_build_stackone_tools(FULL_SPEC)
{% else %}
        tools = []
{% endif %}

        super().__init__(
            name="{{ agent_name }}",
            description={{ (metadata.description | default("CrewAI agent")) | tojson }},
            input_fields={{ (spec.input_fields | map(attribute="name") | list) | tojson }},
            output_fields={{ (spec.output_fields | map(attribute="name") | list) | tojson }},
            variable=resolved_instructions,
            variable_type="instructions",
            framework="crewai",
            config={
                "model": resolved_model,
                "tools_count": len(tools or []),
            },
        )

        self._model_name = resolved_model
        self._task_description = task_description
        self._tools = tools
        self._llm = superoptix_create_crewai_llm(resolved_model, LANGUAGE_MODEL)
        self._crew = None

    def _ensure_crew(self):
        if self._crew is not None:
            return self._crew

        persona = INSTRUCTION_SPEC.get("persona", {}) or {}
        role = str(persona.get("role") or "AI Assistant").strip() or "AI Assistant"
        goal = str(persona.get("goal") or self.variable).strip() or self.variable
        backstory = str(persona.get("backstory") or self.variable).strip() or self.variable

        agent = Agent(
            role=role,
            goal=goal,
            backstory=backstory,
            tools=self._tools,
            llm=self._llm,
            verbose=False,
            allow_delegation=False,
        )
        task = Task(
            description=self._task_description,
            expected_output="A concise, accurate answer.",
            agent=agent,
        )
        self._crew = Crew(
            agents=[agent],
            tasks=[task],
            process=Process.sequential,
            verbose=False,
        )
        return self._crew

    def forward(self, **inputs: Any) -> Dict[str, Any]:
{% if spec.input_fields and spec.input_fields|length > 0 %}
        prompt = str(inputs.get("{{ spec.input_fields[0].name | to_snake_case }}", ""))
{% else %}
        prompt = str(inputs.get("query", ""))
{% endif %}

        crew = self._ensure_crew()
{% if include_rlm_code %}
        text = superoptix_run_with_optional_rlm(
            crew=crew,
            prompt=prompt,
            spec_data=FULL_SPEC,
            model_name=self._model_name,
            task_description=self._task_description,
        )
{% else %}
        result = crew.kickoff(inputs={"query": prompt})
        text = superoptix_extract_crewai_output(result)
{% endif %}

{% if spec.output_fields and spec.output_fields|length > 0 %}
        return {"{{ spec.output_fields[0].name | to_snake_case }}": text}
{% else %}
        return {"output": text}
{% endif %}

    def update(self, new_variable: Any) -> None:
        super().update(new_variable)
        self._crew = None


class {{ agent_name | to_pascal_case }}Pipeline:
    def __init__(
        self,
        model_config: Optional[Dict[str, Any]] = None,
        instructions: Optional[str] = None,
    ):
        self.component = {{ agent_name | to_pascal_case }}Component(
            instructions=instructions,
            model_config=model_config,
        )
        optimizer_cfg = (OPTIMIZATION_CONFIG or {}).get("optimizer", {}) or {}
        params = optimizer_cfg.get("params", {}) if isinstance(optimizer_cfg, dict) else {}
        if params:
            print(
                "ðŸ§¬ Optimization config visible: "
                f"optimizer={optimizer_cfg.get('name', 'GEPA')}, "
                f"auto={params.get('auto', 'light')}, "
                f"max_full_evals={params.get('max_full_evals', 'default')}"
            )

    def run(self, query: Optional[str] = None, **inputs: Any) -> Dict[str, Any]:
        if query is None:
{% if spec.input_fields and spec.input_fields|length > 0 %}
            query = str(inputs.get("{{ spec.input_fields[0].name | to_snake_case }}", ""))
{% else %}
            query = str(inputs.get("query", ""))
{% endif %}

        started = time.time()
        preview = (query[:120] + "...") if query and len(query) > 120 else (query or "")
        print(
            f"ðŸ§  CrewAI run start | model={self.component.config.model} | "
            f"tools={self.component.config.tools_count}"
        )
        print(f"ðŸ“ Prompt: {preview}")

{% if spec.input_fields and spec.input_fields|length > 0 %}
        output = self.component.forward(**{"{{ spec.input_fields[0].name | to_snake_case }}": query or ""})
{% else %}
        output = self.component.forward(**{"query": query or ""})
{% endif %}
        elapsed_ms = int((time.time() - started) * 1000)
        print(f"âœ… CrewAI run done ({elapsed_ms}ms)")
        return output
